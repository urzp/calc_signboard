<style>
    .select_color{
        opacity: 0.01;
    }
    .btn_color, .btn_font{
        cursor: pointer;
    }
    .btn_font_selected .tn-atom{
        color: #fff!important;
        border-color: #78ddf4!important;
        background-color: #03a3df!important;
    }
    .btn_zoom_plus, .btn_zoom_reset, .btn_zoom_minus{
        cursor: pointer;
    }
    .btn_move_plus, .btn_move_reset, .btn_move_minus{
        cursor: pointer;
    }
    .ar_down, .ar_up{
        opacity: 0.01;
    }
    .wrongSize{
        color: #ffffff !important;
        background-color: #ff4f4f !important;
    }
    [name="board_size"]{
        text-align: center;
    }
</style>

<script>
    let fonts, font_files = [], symbols, canvas, ctx;
    let selctedColor, selectedFont, text_board = 'Текст', borderHorizont = true
    let verticalGap = 5
    let textBaseSize = 50, zoom = 0, zoomGap = 10, moveText = 0, moveGap = 50
    let blur_2 = 50, blur_opacity = 0.7

    let k_px_mm = 50/169.25
    let minSymbolSize_mm = 50
    let board_padding_mm = 50

	const URL_FONTS = 'https://fancyneonservis.ru/php/read_fonts.php'
    const URL_SYMBOLS = 'https://fancyneonservis.ru/php/read_symbols.php'
    const URL_FONTS_FILE = 'https://fancyneonservis.ru/fonts/getFont.php'
    const AJAX_OPTIONS = { type: 'POST', headers: { 'Content-Type': 'application/json;charset=utf-8' } }

    $( document ).ready(function(){ init() })

//---------------------------------------------- work space --------------------------------------------------------

function calcBoard(){
    if(borderHorizont) calcHorizontBoard()
}

function calcHorizontBoard(){
   let minWidthBoard = getMinHorizontalBoardWith()
   $('.min_size_title .tn-atom').text(minWidthBoard/10)
   let inputSize = Number( $('[name="board_size"]').val() )
   if(!!inputSize && inputSize < minWidthBoard/10 ){
        $('[name="board_size"]').addClass('wrongSize')
        renderCalcResult('-', '-', '-')
        return false
   }else{
        $('[name="board_size"]').removeClass('wrongSize')
   }    
   if(!inputSize){
    heightBoard = getHorizontalBoardheight()
    renderCalcResult(minWidthBoard, heightBoard , 10)
   }
   

}

function renderCalcResult(width, height, summ){
    $('.board_summ_title .tn-atom').text(summ)
    if(summ == "-" || !summ ){
        $('.board_size_title .tn-atom').text(`-`)
        return false
    }
    $('.board_size_title .tn-atom').text(`${width} cм x ${height} см`)
}

function calcFontSizeHorizontalBoard(){
    let fontSize = getMinFontSize()
    ctx.font = `${fontSize}px ${selectedFont}`
    lenghText_mm = ctx.measureText(text_board).width * k_px_mm
    while(lenghText_mm < Number( $('[name="board_size"]').val() ) * 10 ){
        ctx.font = `${fontSize}px ${selectedFont}`
        lenghText_mm = ctx.measureText(text_board).width / k_px_mm
        fontSize++
    }
    return fontSize
}   

function getMinHorizontalBoardWith(){
    let fontSize = getMinFontSize()
    ctx.font = `${fontSize}px ${selectedFont}`
    lenghText = ctx.measureText(text_board).width
    return Math.round( lenghText * k_px_mm + board_padding_mm * 2 )
}

function getHorizontalBoardheight(fontSize = getMinFontSize()){
    ctx.font = `${fontSize}px ${selectedFont}`
    height = ctx.measureText(text_board).actualBoundingBoxAscent + ctx.measureText(text_board).actualBoundingBoxDescent
    return Math.round( height * k_px_mm + board_padding_mm * 2 )
}


function getMinFontSize(){
    let findSize = textBaseSize;
    ctx.font = `${findSize}px ${selectedFont}`
    leter_w = ctx.measureText("а").width
    while (leter_w < minSymbolSize_mm/k_px_mm){
        ctx.font = `${findSize}px ${selectedFont}`
        leter_w = ctx.measureText("а").width
        findSize++
    }
    return findSize - 1
}



// -------------------------------------------  Init Functions ------------------------------------------------------
    
    async function init(){
        await initCanvas()
        initTextImput()
        initFontsPanel()
        initColorPanel()
        initBorderOrintation()
        initSymbols()
        initZommPanel()
        initMovePanel()
        intSizeBoardPanel()
    }

    function initCanvas(){
        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d")
        canvas.width = $('#canvas').parent().width()
        canvas.height = $('#canvas').parent().height()
        
        CanvasRenderingContext2D.prototype.fillVerticalText =
        function(text, x, y, verticalSpacing) {
            let metrics, priviosSymbolHeight = 0, startSymbolYpos = 0
            y = y - heightVeticalText(text,verticalSpacing)/2
            for (var i = 0; i < text.length; i++) {
                metrics = this.measureText(text[i]);
                startSymbolYpos = startSymbolYpos + metrics.actualBoundingBoxAscent
                this.fillText(text[i], x, y + ( startSymbolYpos ));
                startSymbolYpos = startSymbolYpos + metrics.actualBoundingBoxDescent + verticalSpacing
                if(text[i]==" ") startSymbolYpos = startSymbolYpos + verticalSpacing * 5
            }
        }
    }

    function initTextImput(){
        ready_t_element( '[name="text_board"]', ()=>{
            $('[name="text_board"]').on( 'input', function(){
                text_board = $(this).val()
                renderCanvas()
            })
            $('[name="text_board"]').val(text_board)
        })
    }

        function initZommPanel(){
        $('.btn_zoom_plus').click(()=>{
            zoom = zoom + zoomGap;
            renderCanvas()
        })
        $('.btn_zoom_minus').click(()=>{
            zoom = zoom - zoomGap;
            renderCanvas()
        })
        $('.btn_zoom_reset').click(()=>{
            zoom=0;
            renderCanvas()
        })
    }

    function initMovePanel(){
        $('.btn_move_plus').click(()=>{
            moveText = moveText + moveGap;
            renderCanvas()
        })
        $('.btn_move_minus').click(()=>{
            moveText = moveText - moveGap;
            renderCanvas()
        })
        $('.btn_move_reset').click(()=>{
            moveText=0;
            renderCanvas()
        })
    }

    async function initSymbols(){
        symbols = await ajaxReq(URL_SYMBOLS, AJAX_OPTIONS, {})
    }

    async function initFontsPanel(){
        fonts = await ajaxReq(URL_FONTS, AJAX_OPTIONS, {})
        for(let i=1;i<=10;i++){
            let fontName = fonts[i-1].name
            let font = fonts[i-1]
            $(`.btn_font_${i}`).addClass('btn_font')
            $(`.btn_font_${i}`).attr({'font':fontName.split('.')[0]})
            $(`.btn_font_${i} .tn-atom`).text(fontName.split('.')[0])
            $(`.btn_font_${i}`).attr({'font_base_size':font.baseSize})
        }
        $('.btn_font').click(function(){
            $('.btn_font').removeClass('btn_font_selected')
            $(this).addClass('btn_font_selected')
            selectedFont = $(this).attr('font')
            textBaseSize = $(this).attr('font_base_size')
            renderCanvas()
        })
        $('.btn_font_1').click()

        fonts.forEach(async function(el){
            let fontFace = new FontFace(el.name.split(".")[0], `url(${URL_FONTS_FILE}?font=${el.name})`)
            await fontFace.load().then(function(font){
                //console.log('font ready');
                document.fonts.add(font);
                font_files.push(fontFace)
            });
        })
    }

    function initColorPanel(){
        for(let i=0;i<=14;i++){
            $(`.select_color_${i}`).addClass('select_color')
            $(`.btn_color_${i}`).addClass('btn_color')
            $(`.btn_color_${i}`).attr({'indexColor':i})
        }
        
        $('.btn_color').click(function(){
            $(`.select_color`).css({'opacity':'0.0'})
            let indexColor = $(this).attr('indexColor')
            $(`.select_color_${indexColor}`).css({'opacity':'1.0'})
            selctedColor = $(`.btn_color_${indexColor} .tn-atom`).css('background-color')
            renderCanvas()
        })

        $('.btn_color_1').click()
    }

    function initBorderOrintation(){
        ready_t_element( '.border_orintation_panel', ()=>{
            border_orintation_action()
            $('.t-input-group').click(function(){
                border_orintation_action()
                moveText=0;
                zoom=0;
            })
        })
    }

    function border_orintation_action(){
        if($('[value="Горизонтальная"]').is(':checked')){
            $('[value="Горизонтальная"]').parent().find('span').css({'color':'#fff'})
            borderHorizont = true
            $('.ar_left, .ar_right').css({'opacity':1.0})
            $('.ar_down, .ar_up').css({'opacity':0.01})
        }else{
            $('[value="Горизонтальная"]').parent().find('span').css({'color':'#555'})
            borderHorizont = false
            $('.ar_left, .ar_right').css({'opacity':0.01})
            $('.ar_down, .ar_up').css({'opacity':1.0})
        }
        if($('[value="Вертикальная"]').is(':checked')){
            $('[value="Вертикальная"]').parent().find('span').css({'color':'#fff'})
        }else{
            $('[value="Вертикальная"]').parent().find('span').css({'color':'#555'})
        }
        renderCanvas()
    }

    function intSizeBoardPanel(){
        ready_t_element('[name="board_size"]', ()=>{ 
            $('[name="board_size"]').attr({'type':'number'})
            calcHorizontBoard()
            $('[name="board_size"]').on("change", function(){
                calcBoard()
            })
        })
    }

// -------------------------------------------  Render Functions ------------------------------------------------------
    function renderCanvas(){
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        if(borderHorizont){ horizontalBoard() }else{ verticalBoard() }
        calcBoard()
    }

    function horizontalBoard(){
        ajastWidthText()
        ctx.fillStyle = selctedColor;
        ctx.shadowColor = selctedColor;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        ctx.shadowBlur = 20;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text_board, canvas.width/2  + moveText, canvas.height/2);
        ctx.strokeStyle = selctedColor;
        ctx.strokeText(text_board, canvas.width/2 + moveText, canvas.height/2);
        moreLights( ()=>{ ctx.fillText(text_board, canvas.width/2  + moveText, canvas.height/2) })
    }

    function ajastWidthText(){
        let textWidth, textSize, maxTextWidth = 450
        textSize =  Number(textBaseSize) + Number(zoom)
        ctx.font = `${textSize}px ${selectedFont}`
        textWidth = ctx.measureText(text_board).width
        textHeight = ctx.measureText(text_board).hangingBaseline
        while( textWidth > maxTextWidth && zoom==0){
            ctx.font = `${textSize}px ${selectedFont}`;
            textWidth = ctx.measureText(text_board).width
            textSize--
        }
    }

    function verticalBoard(){
        ajastVerticalText()
        ctx.fillStyle = selctedColor;
        ctx.shadowColor = selctedColor;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        ctx.shadowBlur = 20;
        ctx.fillVerticalText(text_board, canvas.width/2, canvas.height/2  + moveText, 5);
        moreLights( ()=>{ctx.fillVerticalText(text_board, canvas.width/2, canvas.height/2  + moveText , 5)})
    }

    function ajastVerticalText(){
        let maxTextHegth = 300
        textSize =  Number(textBaseSize) + Number(zoom)
        ctx.font = `${textSize}px ${selectedFont}`
        textHeight = heightVeticalText(text_board, verticalGap)
        while( textHeight > maxTextHegth && zoom==0){
            ctx.font = `${textSize}px ${selectedFont}`;
            textHeight = heightVeticalText(text_board, verticalGap)
            textSize--
        }
    }

    function moreLights(fillText){
        let blur_2_color = selctedColor.split(")")[0] + ', ' + blur_opacity +')'
        ctx.shadowColor = blur_2_color;
        ctx.shadowBlur = blur_2; 
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 0;
        fillText()
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 2;
        fillText()
        ctx.shadowOffsetX = -2;
        ctx.shadowOffsetY = 0;
        fillText()
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = -2;
        fillText()
    }

// -------------------------------------------  Suport Functions ------------------------------------------------------

    function heightVeticalText(text,verticalSpacing){
        let heightVeticalText = 0
        for (var i = 0; i < text.length; i++){
            metrics = ctx.measureText(text[i]);
            heightVeticalText = heightVeticalText + metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent + verticalSpacing
            if(text[i]==" ") heightVeticalText = heightVeticalText + verticalSpacing * 5
        }     
        return heightVeticalText
    }

    function ready_t_element(css_selector, action){
        let id_timer = setInterval(()=>{
            if($(css_selector).length > 0){
                action()
                clearInterval( id_timer )
            } 
        }, 300)
    }

	async function ajaxReq(url, options, content){
        let response = await fetch(url,{
            method: options.type,
            headers: options.heders,
            body: JSON.stringify(content)
        })
        return await response.json();
    }
    
</script>